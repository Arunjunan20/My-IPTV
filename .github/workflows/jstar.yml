name: Update JioStar Playlist

on:
  schedule:
    - cron: '0 */3 * * *' # Refreshes every 3 hours to keep Hotstar tokens active
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Process Jio and Hotstar Updates
        run: |
          python <<EOF
          import requests
          import re
          import os

          m3u_file = "jiostar.m3u"
          jio_worker = "https://jtv.pfy.workers.dev"
          hotstar_worker = "https://livetv.panguplay.workers.dev/hotstar?uid=vaathala"

          # IMPORTANT: Added headers to prevent Cloudflare from blocking the request
          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
          }

          try:
              # 1. Fetch Jio Cookie
              jio_res = requests.get(jio_worker, headers=headers, timeout=15)
              jio_match = re.search(r'__hdnea__=([^"\'\s&]+)', jio_res.text)
              jio_token = f"__hdnea__={jio_match.group(1)}" if jio_match else None
              
              # 2. Fetch Hotstar Data
              hs_res = requests.get(hotstar_worker, headers=headers, timeout=20)
              hs_text = hs_res.text
              # Extract Hotstar token
              hs_match = re.search(r'hdntl=exp=[^&"\'\s]+', hs_text)
              hs_token = hs_match.group(0) if hs_match else None

              if not hs_token:
                  print("Warning: Could not fetch Hotstar token. Check worker URL.")

              if not os.path.exists(m3u_file):
                  print(f"Error: {m3u_file} not found")
                  exit(1)

              with open(m3u_file, 'r', encoding='utf-8') as f:
                  lines = f.readlines()

              updated_lines = []
              for i, line in enumerate(lines):
                  line = line.strip()
                  
                  # --- HANDLE HOTSTAR LINES ---
                  if "#EXTHTTP" in line and "hdntl" in line and hs_token:
                      # Update the header cookie
                      line = re.sub(r'hdntl=exp=[^"]+', hs_token, line)
                      updated_lines.append(line)
                  
                  elif "hotstar.com" in line and hs_token:
                      # Check if token exists in link to replace, otherwise append
                      if "hdntl=exp=" in line:
                          line = re.sub(r'hdntl=exp=[^&|]+', hs_token, line)
                      else:
                          # If appending to a fresh master.mpd link, safely add the URL encoded cookie
                          sep = "&" if "?" in line else "?"
                          line = f"{line}{sep}%7CCookie={hs_token}"
                      updated_lines.append(line)

                  # --- HANDLE JIO LINES ---
                  elif "#EXTHTTP" in line and "__hdnea__" in line and jio_token:
                      # Update the Jio #EXTHTTP header cookie
                      line = re.sub(r'__hdnea__=[^"}]+', jio_token, line)
                      updated_lines.append(line)

                  elif "jiotvmblive.cdn.jio.com" in line and jio_token:
                      # Clean existing token and append fresh one
                      clean_link = re.sub(r'([?&])__hdnea__=[^&]*', '', line)
                      sep = "&" if "?" in clean_link else "?"
                      updated_lines.append(f"{clean_link}{sep}{jio_token}")

                  else:
                      updated_lines.append(line)

              # Save results back to the same file
              with open(m3u_file, 'w', encoding='utf-8') as f:
                  f.write("\n".join(updated_lines) + "\n")
              
              print("Successfully updated Jio and Hotstar tokens in jiostar.m3u")

          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add jiostar.m3u
          # Prevents workflow failure if tokens haven't changed yet
          git diff --cached --quiet || git commit -m "Automated update: Refreshed Jio and Hotstar tokens"
          git push
