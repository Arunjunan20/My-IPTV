name: Auto-Update index.html

on:
  schedule:
    - cron: '0 */2 * * *' # Runs every 2 hours
  workflow_dispatch: # Allows manual run

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Run Update Script
        env:
          FILE_NAME: 'index.html'
        run: |
          cat <<EOF > update_script.py
          import requests
          import json
          import os
          import re

          # --- CONFIGURATION ---
          file_name = os.getenv("FILE_NAME", "index.html")
          
          # Source URLs
          source_urls = [
              "https://ztv.pfy.workers.dev",
              "https://z5.pfy.workers.dev",
              "https://raw.githubusercontent.com/fakeall12398-sketch/JIO_TV/aa5248ae47451b2c11745b28e2e8f12dfaa18e4e/jstar.m3u"
          ]

          # Categories
          categories = {
              "Tamil": [
                  "Sun TV HD", "Star Vijay HD", "Zee Tamil HD", "Kalaignar TV", 
                  "Jaya TV HD", "Raj TV", "Adithya", "Thanthi One", "D Tamil", "Sun life",
                  "Polimer TV", "Jothi TV", "OM TV", "Vendhar TV", "Madhimugam TV",
                  "MK Six", "Velicham TV", "Tamilan Television", "Makkal TV", "Puthuyugam TV"
              ],
              "Movies": [
                  "KTV HD", "Zee Thirai", "Vijay Super HD", "Vijay Takkar", 
                  "J Movies", "Raj Digital Plus", "Star Movies HD", 
                  "Star Movies Select HD", "Colors Infinity HD", 
                  "Zee Cafe HD", "&Flix HD", "&Prive HD"
              ],
              "Music": [
                  "Sun Music HD", "Raj Musix", "Jaya Max", "Tunes 6"
              ],
              "News": [
                  "Sun News", "News7 Tamil", "Thanthi TV", 
                  "Raj News 24x7", "Tamil Janam", "Jaya Plus", "M Nadu", "News J"
              ],
              "Sports": [
                  "Star Sports 1 HD", "Star Sports 2 HD", "Star Sports 3", 
                  "Star Sports 1 Tamil HD", "Star Sports 2 Tamil HD", "Eurosport HD",
                  "Jio Sports HD"
              ],
              "Kids": [
                  "Nick Tamil", "Sonic Tamil", "Pogo", "Cartoon Network",
                  "CN HD+ Tamil", "Chutti TV", "Disney Channel", "Disney Junior",
                  "Disney International", "Hungama", "Super Hungama", 
                  "Nick Jr", "Nick HD+", "Discovery Kids",
                  "Sony Yay Hindi" 
              ],
              "Infotainment": [
                  "History TV18 HD", "Discovery HD World", "National Geographic HD", 
                  "Nat Geo Wild HD", "Animal Planet HD World", "Travelxp Tamil", 
                  "Good Times", "Zee Zest HD", "Jio Specials HD",
                  "Discovery Tamil", "Sony BBC Earth HD"
              ]
          }

          # --- 1. HARVEST EXISTING LOGOS ---
          existing_logos = {}
          if os.path.exists(file_name):
              try:
                  with open(file_name, "r", encoding="utf-8") as f:
                      for line in f:
                          if line.strip().startswith("#EXTINF"):
                              parts = line.rsplit(',', 1)
                              if len(parts) == 2:
                                  ch_name = parts[1].strip()
                                  logo_match = re.search(r'tvg-logo="([^"]+)"', line)
                                  if logo_match:
                                      existing_logos[ch_name] = logo_match.group(1)
              except Exception: pass

          # --- 2. GLOBAL TOKEN FINDER ---
          jio_token = None
          zee_token = None

          def find_tokens(items):
              global jio_token, zee_token
              for item in items:
                  link = item.get("link") or item.get("url") or ""
                  if not jio_token and "__hdnea__=" in link:
                      match = re.search(r'(__hdnea__=[^"&|]*)', link)
                      if match: jio_token = match.group(1)
                  if not zee_token and "hdntl=" in link:
                      match = re.search(r'(hdntl=[^"&|]*)', link)
                      if match: zee_token = match.group(1)

          # --- 3. UPDATED M3U PARSER (Catches #EXTHTTP) ---
          def parse_m3u(content):
              items = []
              lines = content.splitlines()
              current_item = {}
              
              for line in lines:
                  line = line.strip()
                  
                  if line.startswith("#EXTINF"):
                      current_item = {} 
                      parts = line.rsplit(',', 1)
                      if len(parts) == 2:
                          current_item['name'] = parts[1].strip()
                      
                      id_match = re.search(r'tvg-id="([^"]+)"', line)
                      if id_match: current_item['tvg_id'] = id_match.group(1)
                      
                      logo_match = re.search(r'tvg-logo="([^"]+)"', line)
                      if logo_match: current_item['tvg_logo'] = logo_match.group(1)

                  elif line.startswith("#KODIPROP"):
                      if "license_key=" in line:
                          key = line.split("license_key=", 1)[1].strip()
                          current_item['drmLicense'] = key
                          current_item['drmScheme'] = 'clearkey'
                      elif "license_type=" in line:
                          type_val = line.split("license_type=", 1)[1].strip()
                          current_item['drmScheme'] = type_val

                  elif line.startswith("#EXTHTTP"):
                      # Capture cookie from #EXTHTTP:{"cookie":"..."}
                      if "cookie" in line:
                          try:
                              # Extract content inside {"cookie":"..."}
                              # Usually looks like #EXTHTTP:{"cookie":"__hdnea__=..."}
                              # We try to extract just the value string
                              cookie_match = re.search(r'"cookie"\s*:\s*"([^"]+)"', line)
                              if cookie_match:
                                  current_item['cookie'] = cookie_match.group(1)
                          except:
                              pass

                  elif line and not line.startswith("#"):
                      # URL Found
                      if 'name' in current_item:
                          current_item['url'] = line
                          items.append(current_item)
                          current_item = {} 
              return items

          # --- 4. PROCESS SOURCE ---
          new_playlist_lines = []
          seen_channels = set()
          
          def extract_from_source(url):
              try:
                  print(f"Scanning: {url}...")
                  response = requests.get(url, timeout=30)
                  response.raise_for_status()
                  content = response.text
                  
                  items = []
                  if content.strip().startswith("#EXTM3U") or ".m3u" in url:
                      items = parse_m3u(content)
                  else:
                      try:
                          data = json.loads(content)
                          if isinstance(data, dict):
                              if "channels" in data: items = data["channels"]
                              elif "data" in data: items = data["data"]
                              elif "list" in data: items = data["list"]
                              else: items = [data]
                          elif isinstance(data, list): items = data
                      except json.JSONDecodeError: return

                  find_tokens(items)

                  for category, targets in categories.items():
                      for target_name in targets:
                          if target_name.lower() in seen_channels:
                              continue

                          matches = [
                              item for item in items 
                              if (item.get("name") or item.get("title") or "").lower().strip() == target_name.lower().strip()
                          ]
                          
                          if matches:
                              matches.sort(key=lambda x: 0 if "BTS" in (x.get("link") or x.get("url") or "") else 1)
                              match = matches[0]
                              
                              name = target_name
                              tvg_id = match.get("tvg_id") or match.get("tvgId") or match.get("id") or ""
                              drm_scheme = match.get("drmScheme") or match.get("drm_scheme") or match.get("drm") or ""
                              drm_license = match.get("drmLicense") or match.get("license") or ""
                              link = match.get("link") or match.get("url") or match.get("stream_url") or match.get("hls") or match.get("mpd") or ""
                              
                              if not link: continue

                              seen_channels.add(target_name.lower())

                              cookie = match.get("cookie") or match.get("cookies") or ""

                              if "jiotvmblive.cdn.jio.com" in link and jio_token:
                                  base = link.split("?")[0]
                                  link = f"{base}?{jio_token}"
                                  cookie = jio_token
                              elif "zee5.com" in link and zee_token:
                                  if "hdntl=" in link:
                                      link = re.sub(r'hdntl=[^&]*', zee_token, link)
                                  else:
                                      sep = "&" if "?" in link else "?"
                                      link = f"{link}{sep}{zee_token}"
                                  cookie = zee_token

                              extinf_parts = ["#EXTINF:-1"]
                              if tvg_id: extinf_parts.append(f'tvg-id="{tvg_id}"')
                              extinf_parts.append(f'group-title="{category}"')
                              
                              if name in existing_logos:
                                  extinf_parts.append(f'tvg-logo="{existing_logos[name]}"')
                              
                              header = " ".join(extinf_parts) + "," + name
                              new_playlist_lines.append(header)

                              # DRM Keys
                              if (drm_scheme == "clearkey" or "clearkey" in drm_scheme) and drm_license:
                                  new_playlist_lines.append(f"#KODIPROP:inputstream.adaptive.license_type=clearkey")
                                  new_playlist_lines.append(f"#KODIPROP:inputstream.adaptive.license_key={drm_license}")
                              
                              # User Agent
                              new_playlist_lines.append("#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0")

                              # Cookie
                              if cookie:
                                  clean_cookie = cookie.replace('"', '\\"')
                                  new_playlist_lines.append(f'#EXTHTTP:{{"cookie":"{clean_cookie}"}}')
                              
                              separator = "&" if "?" in link else "?"
                              if cookie and cookie not in link:
                                  final_url = f"{link}{separator}{cookie}"
                              else:
                                  final_url = link
                                  
                              new_playlist_lines.append(final_url)
                              new_playlist_lines.append("")

              except Exception as e:
                  print(f"Error parsing {url}: {e}")

          for url in source_urls:
              extract_from_source(url)

          if jio_token: print(f"Applied Jio Token: {jio_token[:20]}...")

          # --- INJECT INTO INDEX.HTML ---
          start_marker = "# >>> JIO_AUTO_START"
          end_marker = "# >>> JIO_AUTO_END"
          
          try:
              with open(file_name, "r", encoding="utf-8") as f:
                  content = f.read()

              if start_marker not in content or end_marker not in content:
                  print(f"Error: Markers not found in {file_name}")
                  exit(1)

              pre_content = content.split(start_marker)[0]
              post_content = content.split(end_marker)[1]
              
              new_content = (
                  pre_content + 
                  start_marker + "\n" + 
                  "\n".join(new_playlist_lines) + "\n" + 
                  end_marker + 
                  post_content
              )
              
              with open(file_name, "w", encoding="utf-8") as f:
                  f.write(new_content)
                  
              print(f"Successfully updated {file_name} with {len(new_playlist_lines)//6} channels.")

          except FileNotFoundError:
              print(f"Error: File {file_name} not found.")
              exit(1)
          except Exception as e:
              print(f"Error updating file: {e}")
              exit(1)
          EOF
          
          python update_script.py

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "✅ Auto-update playlist in index.html"
          git push origin main
          
