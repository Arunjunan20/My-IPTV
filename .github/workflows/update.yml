name: Auto-Update index.html

on:
  schedule:
    - cron: '0 */2 * * *' # Runs every 2 hours
  workflow_dispatch: # Allows manual run

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Run Update Script
        env:
          FILE_NAME: 'index.html'
        run: |
          cat <<EOF > update_script.py
          import requests
          import json
          import os

          # --- CONFIGURATION ---
          file_name = os.getenv("FILE_NAME", "index.html")
          
          # Source URLs
          json_urls = [
              "https://ztv.pfy.workers.dev",
              "https://z5.pfy.workers.dev"
          ]

          # Define Categories and their Channels
          categories = {
              "Tamil": [
                  "Sun TV HD", "Star Vijay HD", "Zee Tamil HD", "Kalaignar TV", 
                  "Jaya TV HD", "Raj TV", "Adithya", "Thanthi One", "D Tamil", "Sun life",
                  "Polimer TV", "Jothi TV", "OM TV", "Vendhar TV", "Madhimugam TV",
                  "MK Six", "Velicham TV", "Tamilan Television", "Makkal TV", "Puthuyugam TV"
              ],
              "Movies": [
                  "KTV HD", "Zee Thirai", "Vijay Super HD", "Vijay Takkar", 
                  "J Movies", "Raj Digital Plus", "Star Movies HD", 
                  "Star Movies Select HD", "Colors Infinity HD", 
                  "Zee Cafe HD", "&Flix HD", "&Prive HD"
              ],
              "Music": [
                  "Sun Music HD", "Raj Musix", "Jaya Max", "Tunes 6"
              ],
              "News": [
                  "Sun News", "News7 Tamil", "Thanthi TV", 
                  "Raj News 24x7", "Tamil Janam", "Jaya Plus", "M Nadu", "News J"
              ],
              "Sports": [
                  "Star Sports 1 HD", "Star Sports 2 HD", "Star Sports 3", 
                  "Star Sports 1 Tamil HD", "Star Sports 2 Tamil HD", "Eurosport HD",
                  "Jio Sports HD"
              ],
              "Kids": [
                  "Nick Tamil", "Sonic Tamil", "Pogo", "Cartoon Network",
                  "CN HD+ Tamil", "Chutti TV", "Disney Channel", "Disney Junior",
                  "Disney International", "Hungama", "Super Hungama", 
                  "Nick Jr", "Nick HD+", "Discovery Kids"
              ],
              "Infotainment": [
                  "History TV18 HD", "Discovery HD World", "National Geographic HD", 
                  "Nat Geo Wild HD", "Animal Planet HD World", "Travelxp Tamil", 
                  "Good Times", "Zee Zest HD", "Jio Specials HD"
              ]
          }

          new_playlist_lines = []
          
          def extract_from_json(url):
              try:
                  print(f"Scanning JSON: {url}...")
                  response = requests.get(url, timeout=30)
                  response.raise_for_status()
                  
                  try:
                      data = response.json()
                  except json.JSONDecodeError:
                      print(f"  -> Skipping {url}: Invalid JSON.")
                      return

                  # Normalize data structure
                  if isinstance(data, dict):
                      if "channels" in data and isinstance(data["channels"], list): items = data["channels"]
                      elif "data" in data and isinstance(data["data"], list): items = data["data"]
                      elif "list" in data and isinstance(data["list"], list): items = data["list"]
                      else: items = [data]
                  elif isinstance(data, list):
                      items = data
                  else:
                      items = []

                  count = 0
                  for category, targets in categories.items():
                      for target_name in targets:
                          # Find matching items
                          matches = [
                              item for item in items 
                              if isinstance(item, dict) and (item.get("name") or item.get("title") or "").lower() == target_name.lower()
                          ]
                          
                          if matches:
                              # Sort: Prefer 'BTS' links if available
                              matches.sort(key=lambda x: 0 if "BTS" in (x.get("link") or x.get("url") or "") else 1)
                              match = matches[0]
                              
                              # Extract fields
                              name = target_name
                              tvg_id = match.get("tvg_id") or match.get("tvgId") or match.get("id") or ""
                              
                              # --- LOGIC: LOGO ENABLED ---
                              logo = match.get("tvg_logo") or match.get("logo") or match.get("icon") or ""
                              
                              drm_scheme = match.get("drmScheme") or match.get("drm_scheme") or match.get("drm") or ""
                              drm_license = match.get("drmLicense") or match.get("license") or ""
                              cookie = match.get("cookie") or match.get("cookies") or ""
                              link = match.get("link") or match.get("url") or match.get("stream_url") or match.get("hls") or match.get("mpd") or ""
                              
                              if not link: continue

                              # --- Build Playlist Entry ---
                              
                              # 1. EXTINF Line
                              extinf_parts = ["#EXTINF:-1"]
                              if tvg_id: extinf_parts.append(f'tvg-id="{tvg_id}"')
                              extinf_parts.append(f'group-title="{category}"')
                              
                              # --- LOGIC: LOGO APPENDED ---
                              if logo: extinf_parts.append(f'tvg-logo="{logo}"')
                              
                              header = " ".join(extinf_parts) + "," + name
                              new_playlist_lines.append(header)

                              # 2. DRM Logic (Kodi Prop for ClearKey)
                              if drm_scheme == "clearkey" and drm_license and ":" in drm_license:
                                  key_parts = drm_license.split(":")[:2]
                                  new_playlist_lines.append(f"#KODIPROP:inputstream.adaptive.license_type=clearkey")
                                  new_playlist_lines.append(f"#KODIPROP:inputstream.adaptive.license_key={':'.join(key_parts)}")
                              
                              # 3. User Agent
                              new_playlist_lines.append("#EXTVLCOPT:http-user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 ygx/69.1 Safari/537.36")

                              # 4. Cookie Header
                              if cookie:
                                  clean_cookie = cookie.replace('"', '\\"')
                                  new_playlist_lines.append(f'#EXTHTTP:{{"cookie":"{clean_cookie}"}}')
                              
                              # 5. Final URL
                              separator = "&" if "?" in link else "?"
                              final_url = f"{link}{separator}{cookie}" if cookie else link
                              new_playlist_lines.append(final_url)
                              
                              # 6. Blank Line
                              new_playlist_lines.append("")
                              
                              count += 1

                  print(f"  -> Extracted {count} channels.")

              except Exception as e:
                  print(f"Error parsing JSON {url}: {e}")

          # --- MAIN EXECUTION ---
          for url in json_urls:
              extract_from_json(url)

          # --- INJECT INTO INDEX.HTML ---
          start_marker = "# >>> JIO_AUTO_START"
          end_marker = "# >>> JIO_AUTO_END"
          
          try:
              with open(file_name, "r", encoding="utf-8") as f:
                  content = f.read()

              if start_marker not in content or end_marker not in content:
                  print(f"Error: Markers '{start_marker}' or '{end_marker}' not found in {file_name}")
                  exit(1)

              pre_content = content.split(start_marker)[0]
              post_content = content.split(end_marker)[1]
              
              new_content = (
                  pre_content + 
                  start_marker + "\n" + 
                  "\n".join(new_playlist_lines) + "\n" + 
                  end_marker + 
                  post_content
              )
              
              with open(file_name, "w", encoding="utf-8") as f:
                  f.write(new_content)
                  
              print(f"Successfully updated {file_name} with {len(new_playlist_lines)//6} channels.")

          except FileNotFoundError:
              print(f"Error: File {file_name} not found.")
              exit(1)
          except Exception as e:
              print(f"Error updating file: {e}")
              exit(1)
          EOF
          
          python update_script.py

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "✅ Auto-update playlist in index.html"
          git push origin main
