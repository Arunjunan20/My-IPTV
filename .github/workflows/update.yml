name: Auto-Update index.html (Jio)

concurrency:
  group: auto-update-index
  cancel-in-progress: true

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update Jio Section in index.html
        env:
          JSON_URL: 'https://playify.pages.dev/Jiotv.json'
          FILE_NAME: 'index.html'
        run: |
          set -euo pipefail

          # 1. Target Channel List
          TARGET_CHANNELS='[
            {"name": "Sun TV HD", "group": "Regional Tamil"},
            {"name": "Sun Music HD", "group": "Regional Tamil"},
            {"name": "KTV HD", "group": "Movies"},
            {"name": "Sun Life", "group": "Regional Tamil"},
            {"name": "Raj TV", "group": "Regional Tamil"},
            {"name": "Puthu Yugam", "group": "Tamil"},
            {"name": "Thanthi One", "group": "Tamil"},
            {"name": "Jothi TV", "group": "Tamil"},
            {"name": "D Tamil", "group": "Regional Tamil"},
            {"name": "Travelxp Tamil", "group": "Regional Tamil"},
            {"name": "Raj Musix", "group": "Music"},
            {"name": "Tunes 6", "group": "Music"},
            {"name": "Colors Infinity HD", "group": "Movies"},
            {"name": "Sonic Hindi", "group": "Kids"},
            {"name": "Cartoon Network", "group": "Kids"},
            {"name": "CN HD+ English", "group": "Kids"},
            {"name": "Nick Jr", "group": "Kids"},
            {"name": "Nick HD+", "group": "Kids"},
            {"name": "Nick Hindi", "group": "Kids"},
            {"name": "Pogo", "group": "Kids"},
            {"name": "Raj News 24x7", "group": "News"},
            {"name": "Tamil Janam", "group": "News"},
            {"name": "Jaya Plus", "group": "News"},
            {"name": "History TV18 HD", "group": "Infotainment"},
            {"name": "Animal Planet HD World", "group": "Infotainment"},
            {"name": "Discovery HD World", "group": "Infotainment"},
            {"name": "Eurosport HD", "group": "Sports"},
            {"name": "Jio Sports HD", "group": "Sports"},
            {"name": "Jio Specials HD", "group": "Infotainment"}
          ]'

          # 2. Fetch Source JSON
          echo " Fetching JSON..."
          JSON=$(curl -fsSL --max-time 30 "$JSON_URL") || { echo "❌ Fetch failed"; exit 1; }

          # 3. Generate Formatted Content
          echo " Generating channel block..."
          echo "$JSON" | jq -r --argjson list "$TARGET_CHANNELS" '
            def channels:
              if type == "array" then .
              elif type == "object" then
                if has("channels") and (.channels | type == "array") then .channels
                elif has("data") and (.data | type == "array") then .data
                elif has("list") and (.list | type == "array") then .list
                elif (.[] | type == "object") then [.[]]
                else []
                end
              else []
              end;
            
            channels as $all |
            $list[] as $target_obj |
            $target_obj.name as $target_name |
            $target_obj.group as $target_group | 
            
            # Match Logic
            ($all | 
             map(select((.name // .title // "") | ascii_downcase == ($target_name | ascii_downcase))) | 
             sort_by(if (.link | contains("BTS")) then 0 else 1 end) | 
             .[0]
            ) as $match |
            
            if ($match | type == "object") and ($match.link // $match.url // "") != "" then
              $match |
              $target_name as $name |
              (.tvg_id // .tvgId // .id // "") as $tvg_id |
              (.tvg_logo // .logo // .icon // "") as $tvg_logo |
              (.drmScheme // .drm_scheme // .drm // "") as $drmScheme |
              (.drmLicense // .license // "") as $drmLicense |
              (.cookie // .cookies // "") as $cookie |
              (.link // .url // .stream_url // .hls // .mpd // "") as $link |
              
              "#EXTINF:-1 " +
                (if ($tvg_id | length > 0) then "tvg-id=\"\($tvg_id)\" " else "" end) +
                "group-title=\"\($target_group)\" " +
                (if ($tvg_logo | length > 0) then "tvg-logo=\"\($tvg_logo)\" " else "" end) +
                ",\($name | gsub(","; "\\,"))" |
              . as $extinf |
              
              (if ($drmScheme == "clearkey") and ($drmLicense | test("^[a-zA-Z0-9]+:[a-zA-Z0-9]+")) then
                "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" +
                ($drmLicense | split(":")[0:2] | join(":"))
              else "" end) as $drm |
              
              "#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0" as $ua |
              
              (if ($cookie | length > 0) then
                "#EXTHTTP:{\"cookie\":\"" + ($cookie | gsub("\""; "\\\"")) + "\"}"
              else "" end) as $cookie_header |
              
              ($link + (if ($link | contains("?")) then "&" else "?" end) + $cookie) as $final_url |
              
              [
                $extinf,
                ($drm | select(. != "")),
                $ua,
                ($cookie_header | select(. != "")),
                $final_url
              ] | join("\n")
            else empty end
          ' > jio_update.temp

          # 4. Inject into index.html
          START_MARKER="# >>> JIO_AUTO_START"
          END_MARKER="# >>> JIO_AUTO_END"
          
          if [ -f "$FILE_NAME" ]; then
            sed -i "/$START_MARKER/,/$END_MARKER/{//!d}" "$FILE_NAME"
            sed -i "/$START_MARKER/r jio_update.temp" "$FILE_NAME"
            echo "✅ index.html updated successfully."
          else
            echo "❌ File $FILE_NAME not found!"
            exit 1
          fi
          rm jio_update.temp

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "✅ Auto-update index.html (Every 2h)"
          git push origin main
